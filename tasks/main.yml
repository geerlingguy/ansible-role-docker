---
- include: setup-RedHat.yml
  when: ansible_os_family == 'RedHat'

- include: setup-Debian.yml
  when: ansible_os_family == 'Debian'

- name: Install Docker.
  package: name={{ docker_package }} state={{ docker_package_state }}

- name: enable remote docker access
  block:
    - name: add docker.service.d/override.conf override
      copy:
        dest: /etc/systemd/system/docker.service.d/startup_options.conf
        content: |
          # /etc/systemd/system/docker.service.d/override.conf
          [Service]
          ExecStart=
          ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375
      register: docker_override

    - name: reload docker daemon
      systemd:
        daemon_reload: yes
      when: docker_override is changed

    - name: restart docker service
      service:
        name: docker
        state: restarted
        daemon_reload: yes
      when: docker_override is changed

  when: (
      docker_remote_access is defined
    ) and (
     ( docker_remote_access )
    )


- name: Ensure Docker is started and enabled at boot.
  service:
    name: docker
    state: started
    enabled: yes

- include: docker-compose.yml
  when: docker_install_compose
