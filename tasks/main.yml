---
- include_tasks: setup-RedHat.yml
  when: ansible_os_family == 'RedHat'

- include_tasks: setup-Debian.yml
  when: ansible_os_family == 'Debian'

- name: Install Docker.
  package:
    name: "{{ docker_package }}"
    state: "{{ docker_package_state }}"
  notify: restart docker

- name: enable remote docker access
  block:
    - name: add docker.service.d/override.conf override
      copy:
        dest: /etc/systemd/system/docker.service.d/startup_options.conf
        content: |
          # /etc/systemd/system/docker.service.d/override.conf
          [Service]
          ExecStart=
          ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375
      register: docker_override

    - name: reload docker daemon
      systemd:
        daemon_reload: yes
      when: docker_override is changed

    - name: restart docker service
      service:
        name: docker
        state: restarted
        daemon_reload: yes
      when: docker_override is changed

  when: (
      docker_remote_access is defined
    ) and (
     ( docker_remote_access )
    )


- name: Ensure Docker is started and enabled at boot.
  service:
    name: docker
    state: "{{ docker_service_state }}"
    enabled: "{{ docker_service_enabled }}"

- name: Ensure handlers are notified now to avoid firewall conflicts.
  meta: flush_handlers

- include_tasks: docker-compose.yml
  when: docker_install_compose

- include_tasks: docker-users.yml
  when: docker_users
